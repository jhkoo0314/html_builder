<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Step3 Composer</title>
    <style>
      :root {
        --bg: #f4f7fb;
        --panel: #ffffff;
        --line: #d5dfec;
        --ink: #17212e;
        --muted: #5b6a7f;
        --brand: #0f766e;
        --brand-2: #0b5b55;
        --warn: #9a3412;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Segoe UI", sans-serif;
        color: var(--ink);
        background: radial-gradient(900px 360px at 0% -10%, #edf7ff 0%, transparent 65%), var(--bg);
      }
      .topbar {
        position: sticky;
        top: 0;
        z-index: 10;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        border-bottom: 1px solid var(--line);
        background: #fff;
      }
      .left, .right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
      .hint { color: var(--muted); font-size: 12px; }
      .layout {
        display: grid;
        grid-template-columns: 360px 1fr;
        gap: 10px;
        padding: 10px;
        min-height: calc(100vh - 58px);
      }
      .panel {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px;
      }
      .panel h3 {
        margin: 0 0 10px;
        color: var(--muted);
        font-size: 14px;
      }
      .form-row { display: grid; gap: 6px; margin-bottom: 10px; }
      .form-row label { color: var(--muted); font-size: 12px; }
      select, textarea, input[type="text"] {
        width: 100%;
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 8px;
        font: inherit;
        background: #fff;
      }
      textarea { min-height: 120px; resize: vertical; }
      button, .btn {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 8px;
        padding: 8px 10px;
        cursor: pointer;
        color: var(--ink);
        text-decoration: none;
      }
      .btn-primary {
        background: var(--brand);
        color: #fff;
        border-color: var(--brand);
      }
      .btn-primary:hover { background: var(--brand-2); border-color: var(--brand-2); }
      button:disabled { opacity: .55; cursor: not-allowed; }
      .stack { display: flex; flex-wrap: wrap; gap: 6px; }
      .meta {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        font-size: 12px;
      }
      .meta div {
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 8px;
        background: #fbfdff;
      }
      .log {
        margin-top: 10px;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #f7fbff;
        padding: 8px;
      }
      .log ul {
        margin: 0;
        padding-left: 18px;
        max-height: 220px;
        overflow: auto;
        font-size: 12px;
      }
      .warn {
        margin-top: 8px;
        font-size: 12px;
        color: var(--warn);
      }
      .preview-wrap { height: calc(100vh - 90px); }
      iframe {
        width: 100%;
        height: 100%;
        border: 1px solid var(--line);
        border-radius: 8px;
        background: #fff;
      }
      @media (max-width: 1100px) {
        .layout { grid-template-columns: 1fr; }
        .preview-wrap { height: 58vh; }
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="left">
        <strong>Step3 Composer</strong>
        <span id="statusText" class="hint">Waiting for Step2 input</span>
      </div>
      <div class="right">
        <button id="btnBackStep2" type="button">Back to Step2</button>
        <a id="btnDownload" class="btn" href="#" download="step3-composed.html">Download Step3 HTML</a>
      </div>
    </header>

    <main class="layout">
      <section class="panel">
        <h3>Input</h3>
        <div id="inputInfo" class="hint">Input source: N/A</div>
        <div class="warn">Saved output location: localStorage key <code>STEP3_HTML</code></div>
        <div class="form-row" style="margin-top:10px;">
          <label for="styleMode">Style mode</label>
          <select id="styleMode">
            <option value="normal">Normal</option>
            <option value="creative" selected>Creative</option>
            <option value="extreme">Extreme</option>
          </select>
        </div>
        <div class="form-row">
          <label for="toneMode">Tone mode</label>
          <select id="toneMode">
            <option value="auto" selected>Auto</option>
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
        </div>
        <div class="form-row">
          <label for="designPrompt">Design prompt (optional)</label>
          <textarea id="designPrompt">Recompose slides with high visual freedom, but use only the approved 12 slide types. Keep or adapt slide count naturally from content.</textarea>
        </div>
        <div class="stack">
          <button id="btnRun" class="btn-primary" type="button">Run Step3</button>
          <button id="btnReloadInput" type="button">Reload Input</button>
          <button id="btnApplyToStep2" type="button" disabled>Apply Output To Step2</button>
        </div>

        <h3 style="margin-top:14px;">Debug</h3>
        <div class="meta" id="meta"></div>
        <div class="log">
          <ul id="logs"></ul>
        </div>
      </section>

      <section class="panel preview-wrap">
        <iframe id="preview" title="Step3 Preview"></iframe>
      </section>
    </main>

    <script>
      const STEP2_KEY = "STEP2A_HTML";
      const STEP3_INPUT_KEY = "STEP3_INPUT_HTML";
      const STEP3_OUTPUT_KEY = "STEP3_HTML";
      const STEP3_OUTPUT_INPUT_HASH_KEY = "STEP3_HTML_INPUT_HASH";

      const state = {
        inputHtml: "",
        outputHtml: "",
        startedAt: 0,
        timer: null,
        blobUrl: "",
      };

      const els = {
        statusText: document.getElementById("statusText"),
        inputInfo: document.getElementById("inputInfo"),
        styleMode: document.getElementById("styleMode"),
        toneMode: document.getElementById("toneMode"),
        designPrompt: document.getElementById("designPrompt"),
        btnRun: document.getElementById("btnRun"),
        btnReloadInput: document.getElementById("btnReloadInput"),
        btnApplyToStep2: document.getElementById("btnApplyToStep2"),
        btnBackStep2: document.getElementById("btnBackStep2"),
        btnDownload: document.getElementById("btnDownload"),
        preview: document.getElementById("preview"),
        meta: document.getElementById("meta"),
        logs: document.getElementById("logs"),
      };

      function nowLabel() {
        const d = new Date();
        return `${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}:${String(d.getSeconds()).padStart(2, "0")}`;
      }

      function countSlides(html) {
        return (String(html || "").match(/<section[^>]*class=["'][^"']*slide/gi) || []).length;
      }

      function hashText(text) {
        const s = String(text || "");
        let h = 2166136261;
        for (let i = 0; i < s.length; i += 1) {
          h ^= s.charCodeAt(i);
          h += (h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24);
        }
        return (h >>> 0).toString(16);
      }

      function log(msg) {
        const li = document.createElement("li");
        li.textContent = `[${nowLabel()}] ${msg}`;
        els.logs.appendChild(li);
      }

      function setMeta(items) {
        els.meta.innerHTML = "";
        items.forEach(([k, v]) => {
          const div = document.createElement("div");
          div.textContent = `${k}: ${v == null || v === "" ? "N/A" : v}`;
          els.meta.appendChild(div);
        });
      }

      function setBusy(flag) {
        els.btnRun.disabled = flag || !state.inputHtml.trim();
        if (flag) {
          state.startedAt = Date.now();
          if (state.timer) clearInterval(state.timer);
          state.timer = setInterval(() => {
            const sec = Math.floor((Date.now() - state.startedAt) / 1000);
            els.statusText.textContent = `Step3 running... ${sec}s`;
          }, 1000);
        } else if (state.timer) {
          clearInterval(state.timer);
          state.timer = null;
        }
      }

      function setPreview(html) {
        els.preview.srcdoc = html || "";
        const blob = new Blob([html || ""], { type: "text/html;charset=utf-8" });
        if (state.blobUrl) URL.revokeObjectURL(state.blobUrl);
        state.blobUrl = URL.createObjectURL(blob);
        els.btnDownload.href = state.blobUrl;
      }

      function loadInput() {
        const fromStep3 = localStorage.getItem(STEP3_INPUT_KEY) || "";
        const fromStep2 = localStorage.getItem(STEP2_KEY) || "";
        const html = (fromStep3 || fromStep2 || "").trim();
        state.inputHtml = html;
        els.btnRun.disabled = !html;
        if (!html) {
          state.outputHtml = "";
          setPreview("");
          els.btnApplyToStep2.disabled = true;
          els.inputInfo.textContent = "Input source: missing (STEP3_INPUT_HTML / STEP2A_HTML)";
          els.statusText.textContent = "No Step2 input found";
          setMeta([["inputSlides", 0], ["outputSlides", 0], ["elapsedMs", 0], ["status", "IDLE"]]);
          return;
        }
        const source = fromStep3 ? STEP3_INPUT_KEY : STEP2_KEY;
        els.inputInfo.textContent = `Input source: ${source}`;
        els.statusText.textContent = `Loaded input - ${countSlides(html)} slides`;
        setMeta([["inputSlides", countSlides(html)], ["outputSlides", state.outputHtml ? countSlides(state.outputHtml) : 0], ["elapsedMs", 0], ["status", "READY"]]);
      }

      async function runStep3() {
        if (!state.inputHtml.trim()) return;
        els.logs.innerHTML = "";
        log(`Start Step3 (style=${els.styleMode.value}, tone=${els.toneMode.value})`);
        setBusy(true);

        try {
          const form = new FormData();
          form.append("documents", new Blob([state.inputHtml], { type: "text/plain;charset=utf-8" }), "step2-edited.html");
          form.append("styleMode", els.styleMode.value || "creative");
          form.append("toneMode", els.toneMode.value || "auto");
          form.append("recomposeMode", "step3");
          form.append("designPrompt", String(els.designPrompt.value || "").trim());

          log("Calling /api/l3/build-direct");
          const res = await fetch("/api/l3/build-direct", { method: "POST", body: form });
          const json = await res.json().catch(() => ({}));
          if (!res.ok || !json || !json.ok) {
            throw new Error(json.message || json.error || "Step3 build failed");
          }

          const outHtml = String(json.html || "");
          if (!outHtml.trim()) throw new Error("Step3 returned empty html");

          state.outputHtml = outHtml;
          setPreview(outHtml);
          localStorage.setItem(STEP3_OUTPUT_KEY, outHtml);
          localStorage.setItem(STEP3_OUTPUT_INPUT_HASH_KEY, hashText(state.inputHtml));
          els.btnApplyToStep2.disabled = false;

          const variant = (json.htmlVariants && json.htmlVariants[0]) || {};
          const meta = variant.meta || {};
          const slideTypes = Array.isArray(meta.slideTypes) ? meta.slideTypes : [];
          const uniqueTypeCount = Array.from(new Set(slideTypes)).length;
          const elapsed = Date.now() - state.startedAt;
          setMeta([
            ["runId", json.runId || meta.runId || ""],
            ["recomposeMode", json.recomposeMode || "none"],
            ["status", json.status || meta.status || "UNKNOWN"],
            ["inputSlides", countSlides(state.inputHtml)],
            ["outputSlides", meta.slideCount || countSlides(outHtml)],
            ["typeAssignments", slideTypes.length],
            ["uniqueTypes", uniqueTypeCount],
            ["elapsedMs", elapsed],
            ["analyzeMs", meta.timings && meta.timings.analyzeMs],
            ["renderMs", meta.timings && meta.timings.renderMs],
            ["totalMs", meta.timings && meta.timings.totalMs],
            ["whyFallback", json.whyFallback || meta.whyFallback || "N/A"],
            ["llmAttempts", Array.isArray(meta.llmAttempts) ? meta.llmAttempts.length : 0],
          ]);
          log(`Done: status=${json.status || meta.status || "UNKNOWN"}, slides=${meta.slideCount || countSlides(outHtml)}, elapsed=${elapsed}ms`);
          els.statusText.textContent = `Step3 done - ${meta.slideCount || countSlides(outHtml)} slides`;
        } catch (err) {
          const elapsed = Date.now() - state.startedAt;
          log(`Failed: ${err.message}`);
          els.statusText.textContent = `Step3 failed (${elapsed}ms)`;
          setMeta([
            ["inputSlides", countSlides(state.inputHtml)],
            ["outputSlides", 0],
            ["elapsedMs", elapsed],
            ["status", "FAILED"],
            ["error", err.message],
          ]);
        } finally {
          setBusy(false);
        }
      }

      function applyOutputToStep2() {
        if (!state.outputHtml.trim()) return;
        localStorage.setItem(STEP2_KEY, state.outputHtml);
        localStorage.setItem(STEP3_INPUT_KEY, state.outputHtml);
        log("Applied Step3 output to STEP2A_HTML");
        els.statusText.textContent = "Applied output to Step2 storage";
      }

      els.btnRun.addEventListener("click", runStep3);
      els.btnReloadInput.addEventListener("click", loadInput);
      els.btnApplyToStep2.addEventListener("click", applyOutputToStep2);
      els.btnBackStep2.addEventListener("click", () => {
        window.location.href = "/editor.html";
      });

      window.addEventListener("beforeunload", () => {
        if (state.timer) clearInterval(state.timer);
        if (state.blobUrl) URL.revokeObjectURL(state.blobUrl);
      });

      loadInput();
      const existingOutput = localStorage.getItem(STEP3_OUTPUT_KEY) || "";
      const existingOutputInputHash = localStorage.getItem(STEP3_OUTPUT_INPUT_HASH_KEY) || "";
      const currentInputHash = hashText(state.inputHtml);
      if (existingOutput.trim() && existingOutputInputHash && existingOutputInputHash === currentInputHash) {
        state.outputHtml = existingOutput;
        setPreview(existingOutput);
        els.btnApplyToStep2.disabled = false;
      } else {
        state.outputHtml = "";
        setPreview("");
        els.btnApplyToStep2.disabled = true;
      }
    </script>
  </body>
</html>
