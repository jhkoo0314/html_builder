<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Report2Slide v1</title>
    <style>
      :root { --bg:#f5f7fb; --ink:#111827; --muted:#6b7280; --line:#d1d5db; --pri:#0f766e; }
      * { box-sizing:border-box; }
      body { margin:0; font-family: "Segoe UI", sans-serif; background:var(--bg); color:var(--ink); }
      .wrap { max-width:1200px; margin:24px auto; padding:0 16px; }
      .panel { background:#fff; border:1px solid var(--line); border-radius:12px; padding:16px; }
      .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      button { border:0; background:var(--pri); color:#fff; padding:10px 14px; border-radius:8px; cursor:pointer; }
      button[disabled] { opacity:0.6; cursor:not-allowed; }
      a.btn { display:inline-block; text-decoration:none; border:1px solid var(--line); color:var(--ink); padding:10px 14px; border-radius:8px; }
      .meta { margin-top:12px; display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:8px; }
      .meta div { border:1px solid var(--line); border-radius:8px; padding:8px; background:#fafafa; font-size:13px; }
      iframe { width:100%; height:70vh; border:1px solid var(--line); border-radius:12px; margin-top:16px; background:#fff; }
      .err { color:#b91c1c; margin-top:10px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="panel">
        <div class="row">
          <input id="files" type="file" multiple>
          <button id="generate">Generate</button>
          <a id="download" class="btn" download="report2slide.html" href="#">Download</a>
        </div>
        <div id="meta" class="meta"></div>
        <div id="error" class="err"></div>
      </div>
      <iframe id="preview" title="preview"></iframe>
    </div>

    <script>
      let blobUrl = "";
      const fields = [
        "mode", "renderMode", "whyFallback", "extractionMethod", "finalizeApplied", "repairAttempted",
        "rawLength", "extractedLength", "slideCount", "timings.totalMs", "timings.generateMs", "timings.repairMs",
        "llmAttempts"
      ];

      function pick(obj, key) {
        return key.split(".").reduce((acc, k) => (acc && acc[k] !== undefined ? acc[k] : undefined), obj);
      }

      function renderMeta(data) {
        const root = document.getElementById("meta");
        root.innerHTML = "";
        for (const key of fields) {
          const v = pick(data, key);
          const item = document.createElement("div");
          item.textContent = `${key}: ${v === undefined || v === null || v === "" ? "N/A" : v}`;
          root.appendChild(item);
        }
      }

      async function onGenerate() {
        const input = document.getElementById("files");
        const btn = document.getElementById("generate");
        const err = document.getElementById("error");
        const iframe = document.getElementById("preview");
        const download = document.getElementById("download");

        err.textContent = "";
        btn.disabled = true;
        try {
          const form = new FormData();
          for (const f of input.files) form.append("documents", f);

          const res = await fetch("/api/generate-llm", { method: "POST", body: form });
          const json = await res.json();
          if (!res.ok) throw new Error(json.message || "Request failed");

          const variant = (json.htmlVariants && json.htmlVariants[0]) || {};
          const merged = {
            mode: json.mode,
            renderMode: variant.renderMode,
            whyFallback: variant.whyFallback,
            extractionMethod: variant.extractionMethod,
            finalizeApplied: variant.finalizeApplied,
            repairAttempted: variant.repairAttempted,
            rawLength: variant.meta && variant.meta.rawLength,
            extractedLength: variant.meta && variant.meta.extractedLength,
            slideCount: variant.meta && variant.meta.slideCount,
            timings: variant.meta && variant.meta.timings,
            llmAttempts: variant.meta && variant.meta.llmAttempts ? JSON.stringify(variant.meta.llmAttempts) : "N/A",
          };
          renderMeta(merged);

          iframe.srcdoc = json.html || "";

          const blob = new Blob([json.html || ""], { type: "text/html;charset=utf-8" });
          if (blobUrl) URL.revokeObjectURL(blobUrl);
          blobUrl = URL.createObjectURL(blob);
          download.href = blobUrl;
        } catch (e) {
          err.textContent = e.message;
        } finally {
          btn.disabled = false;
        }
      }

      document.getElementById("generate").addEventListener("click", onGenerate);
      window.addEventListener("beforeunload", () => {
        if (blobUrl) URL.revokeObjectURL(blobUrl);
      });
    </script>
  </body>
</html>
