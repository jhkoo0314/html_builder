<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Report2Slide</title>
  <style>
    body { font-family: "Segoe UI", sans-serif; margin: 0; background: #f8fafc; color: #0f172a; }
    .wrap { max-width: 1100px; margin: 24px auto; background: #fff; border: 1px solid #dbe3ef; border-radius: 14px; padding: 20px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .board { margin-top: 12px; display: grid; gap: 10px; }
    .card { border: 1px solid #dbe3ef; border-radius: 10px; padding: 10px; background: #fcfdff; }
    .card-top { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .grow { flex: 1; min-width: 220px; }
    input[type="file"], input, textarea, select { border: 1px solid #cfd8e3; border-radius: 8px; padding: 8px 10px; font-family: inherit; }
    textarea { width: 100%; min-height: 84px; resize: vertical; }
    button, .btn { border: 1px solid #cfd8e3; border-radius: 8px; padding: 9px 12px; cursor: pointer; background: #fff; color: #0f172a; text-decoration: none; }
    .primary { background: #0f766e; color: #fff; border-color: #0f766e; }
    .danger { color: #b42318; border-color: #f3c7c3; }
    .muted { color: #475569; }
    .hidden { display: none !important; }
    .render-busy {
      margin: 8px 0 0;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #bfe3df;
      background: #ecfdfa;
      color: #115e59;
      font-size: 13px;
      font-weight: 600;
    }
    .progress { margin: 12px 0; border: 1px solid #dbe3ef; background: #f8fbff; border-radius: 10px; padding: 10px; display: grid; gap: 8px; }
    .progress-head { display: flex; gap: 10px; align-items: center; }
    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid #c6d7ee;
      border-top-color: #0f766e;
      border-radius: 50%;
      animation: spin .9s linear infinite;
    }
    .progress-log { margin: 0; padding-left: 18px; color: #334155; font-size: 13px; display: grid; gap: 4px; }
    .quality-gate {
      margin: 10px 0;
      border: 1px solid #f3d6b1;
      background: #fff7ed;
      border-radius: 10px;
      padding: 10px;
      display: grid;
      gap: 8px;
    }
    .quality-gate strong { color: #9a3412; }
    .quality-gate p { margin: 0; color: #7c2d12; font-size: 13px; }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Report2Slide</h1>
    <p class="muted">Generate HTML decks directly from documents with Gemini.</p>

    <form id="analyzeForm" class="row">
      <input id="documents" type="file" multiple accept=".pdf,.docx,.txt,.md" required />      <label>Model
        <select id="llmModelInput">
          <option value="gemini-3-flash-preview">gemini-3-flash-preview</option>
          <option value="gemini-2.5-flash">gemini-2.5-flash</option>
        </select>
      </label>
      <button class="primary" type="submit">1) Generate Direct HTML</button>
    </form>

    <p id="status"></p>
    <p id="meta" class="muted"></p>
    <p id="modelCallStats" class="muted">Model calls: -</p>
    <section id="progressBox" class="progress hidden">
      <div class="progress-head">
        <span class="spinner" aria-hidden="true"></span>
        <strong id="progressTitle">Processing...</strong>
      </div>
      <ul id="progressLog" class="progress-log"></ul>
    </section>
    <section id="qualityGate" class="quality-gate hidden">
      <strong>분석 결과 확인 필요</strong>
      <p id="qualityGateText">슬라이드 수가 기준보다 적게 생성되었습니다. 재분석하거나 그대로 진행할 수 있습니다.</p>
      <div class="row">
        <button id="retryAnalyzeBtn" type="button">재분석</button>
        <button id="continueAnalyzeBtn" class="primary" type="button">그대로 진행</button>
      </div>
    </section>
    <section id="directResultSection" class="hidden">
      <div id="directResultActions" class="row" style="margin-top:10px;"></div>
    </section>

    <section id="approvalSection" class="hidden">
      <div id="board" class="board"></div>

      <div class="row" style="margin-top:10px;">
        <button id="addSlideBtn" type="button">+ Add Slide</button>
        <button id="resetBtn" type="button">Reset Draft</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>Render Model
          <select id="renderModelInput">
            <option value="gemini-3-flash-preview">gemini-3-flash-preview</option>
            <option value="gemini-2.5-flash">gemini-2.5-flash</option>
          </select>
        </label>
        <button id="approveBtn" class="primary" type="button">2) Render HTML</button>
      </div>
      <p id="renderBusy" class="render-busy hidden">?뚮뜑留?以?.. (0s)</p>
      <p class="muted" style="margin:8px 0 0;">遺꾩꽍 ?꾩뿉???ㅽ??쇱쓣 諛붽퓭????踰꾪듉留??ㅼ떆 ?꾨Ⅴ硫??щ텇???놁씠 ?щ젋?붾쭅?⑸땲??</p>

      <div id="resultActions" class="row" style="margin-top:10px;"></div>
    </section>
  </main>

  <script>
    const analyzeForm = document.getElementById("analyzeForm");
    const statusEl = document.getElementById("status");
    const metaEl = document.getElementById("meta");
    const approvalSection = document.getElementById("approvalSection");
    const boardEl = document.getElementById("board");
    const addSlideBtn = document.getElementById("addSlideBtn");
    const resetBtn = document.getElementById("resetBtn");
    const approveBtn = document.getElementById("approveBtn");
    const resultActionsEl = document.getElementById("resultActions");
    const directResultSection = document.getElementById("directResultSection");
    const directResultActionsEl = document.getElementById("directResultActions");
    const llmModelInput = document.getElementById("llmModelInput");
    const renderModelInput = document.getElementById("renderModelInput");
    const progressBox = document.getElementById("progressBox");
    const progressTitle = document.getElementById("progressTitle");
    const progressLog = document.getElementById("progressLog");
    const modelCallStats = document.getElementById("modelCallStats");
    const qualityGate = document.getElementById("qualityGate");
    const qualityGateText = document.getElementById("qualityGateText");
    const retryAnalyzeBtn = document.getElementById("retryAnalyzeBtn");
    const continueAnalyzeBtn = document.getElementById("continueAnalyzeBtn");
    const renderBusy = document.getElementById("renderBusy");
    const analyzeBtn = analyzeForm.querySelector('button[type="submit"]');

    let slides = [];
    let originalSlides = [];
    let dragIndex = null;
    let currentMode = "llm-gemini";
    let progressTimer = null;
    let progressSec = 0;
    let progressBaseTitle = "";
    let renderTimer = null;
    let renderSec = 0;
    let qualityDecisionPending = false;
    const modelCallCountMap = {};
    let modelCallResetPtDayKey = "";
    let modelCallResetWatcher = null;
    const MODEL_CALL_STORAGE_KEY = "report2slide:modelCallCount:v1";
    const activeObjectUrls = new Set();

    function saveModelCallStatsState() {
      try {
        const payload = {
          dayKey: modelCallResetPtDayKey || getPtDayKey(new Date()),
          counts: modelCallCountMap,
        };
        localStorage.setItem(MODEL_CALL_STORAGE_KEY, JSON.stringify(payload));
      } catch (_) {
        // ignore storage failures
      }
    }

    function loadModelCallStatsState() {
      try {
        const raw = localStorage.getItem(MODEL_CALL_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== "object") return;
        const savedDayKey = String(parsed.dayKey || "");
        const nowDayKey = getPtDayKey(new Date());
        modelCallResetPtDayKey = savedDayKey || nowDayKey;
        if (savedDayKey && savedDayKey !== nowDayKey) return;
        const savedCounts = parsed.counts && typeof parsed.counts === "object" ? parsed.counts : {};
        Object.keys(savedCounts).forEach((k) => {
          const n = Number(savedCounts[k] || 0);
          if (Number.isFinite(n) && n > 0) modelCallCountMap[k] = n;
        });
      } catch (_) {
        // ignore parse/storage failures
      }
    }

    function setStatus(msg) { statusEl.textContent = msg; }
    function getPtDayKey(date = new Date()) {
      const fmt = new Intl.DateTimeFormat("en-CA", {
        timeZone: "America/Los_Angeles",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
      });
      return fmt.format(date);
    }
    function maybeResetModelCallByPtMidnight() {
      const nowKey = getPtDayKey(new Date());
      if (!modelCallResetPtDayKey) {
        modelCallResetPtDayKey = nowKey;
        return;
      }
      if (nowKey !== modelCallResetPtDayKey) {
        Object.keys(modelCallCountMap).forEach((k) => delete modelCallCountMap[k]);
        modelCallResetPtDayKey = nowKey;
        saveModelCallStatsState();
      }
    }
    function getNextPtResetLabel() {
      const now = new Date();
      const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
      const fmt = new Intl.DateTimeFormat("en-US", {
        timeZone: "America/Los_Angeles",
        month: "2-digit",
        day: "2-digit",
      });
      return `${fmt.format(tomorrow)} 00:00 PT`;
    }
    function renderModelCallStats() {
      maybeResetModelCallByPtMidnight();
      const rows = Object.entries(modelCallCountMap)
        .sort((a, b) => a[0].localeCompare(b[0]))
        .map(([model, count]) => `${model}: ${count}`);
      const resetText = `reset: ${getNextPtResetLabel()}`;
      modelCallStats.textContent = rows.length
        ? `Model calls: ${rows.join(" | ")} (${resetText})`
        : `Model calls: - (${resetText})`;
    }
    function trackModelCall(modelName) {
      maybeResetModelCallByPtMidnight();
      const key = String(modelName || "unknown").trim() || "unknown";
      modelCallCountMap[key] = (modelCallCountMap[key] || 0) + 1;
      saveModelCallStatsState();
      renderModelCallStats();
    }
    function setBusy(disabled) {
      [analyzeBtn, addSlideBtn, resetBtn, approveBtn, llmModelInput, renderModelInput]
        .forEach((el) => { if (el) el.disabled = disabled; });
      if (retryAnalyzeBtn) retryAnalyzeBtn.disabled = disabled;
      if (continueAnalyzeBtn) continueAnalyzeBtn.disabled = disabled;
    }
    function clearProgressLog() { progressLog.innerHTML = ""; }
    function addProgressLog(msg) {
      const li = document.createElement("li");
      li.textContent = msg;
      progressLog.appendChild(li);
    }
    function startProgress(title) {
      progressBaseTitle = title;
      progressSec = 0;
      progressTitle.textContent = `${title} (0s)`;
      progressBox.classList.remove("hidden");
      if (progressTimer) clearInterval(progressTimer);
      progressTimer = setInterval(() => {
        progressSec += 1;
        progressTitle.textContent = `${progressBaseTitle} (${progressSec}s)`;
      }, 1000);
    }
    function stopProgress() {
      if (progressTimer) clearInterval(progressTimer);
      progressTimer = null;
      progressBox.classList.add("hidden");
    }
    function startRenderBusy() {
      renderSec = 0;
      renderBusy.textContent = "?뚮뜑留?以?.. (0s)";
      renderBusy.classList.remove("hidden");
      if (renderTimer) clearInterval(renderTimer);
      renderTimer = setInterval(() => {
        renderSec += 1;
        renderBusy.textContent = `?뚮뜑留?以?.. (${renderSec}s)`;
      }, 1000);
    }
    function stopRenderBusy() {
      if (renderTimer) clearInterval(renderTimer);
      renderTimer = null;
      renderBusy.classList.add("hidden");
    }
    function hideQualityGate() {
      qualityGate.classList.add("hidden");
      qualityDecisionPending = false;
      approveBtn.disabled = false;
    }
    function showQualityGate(slideCount) {
      qualityDecisionPending = true;
      approveBtn.disabled = true;
      qualityGateText.textContent = `?щ씪?대뱶媛 ${slideCount}?μ쑝濡??앹꽦?섏뼱 ?덉쭏 ??섍? ?섏떖?⑸땲?? ?щ텇?앺븯嫄곕굹 洹몃?濡?吏꾪뻾???좏깮??二쇱꽭??`;
      qualityGate.classList.remove("hidden");
    }
    function cloneSlides(list) {
      return list.map((s) => ({
        id: s.id,
        title: s.title,
        bullets: Array.isArray(s.bullets) ? [...s.bullets] : [],
        type: s.type || "content",
        subtitle: s.subtitle || "",
        stat: s.stat || "",
        layoutIntent: s.layoutIntent || "",
        visualPriority: s.visualPriority || "",
        dataDensity: s.dataDensity || "",
        componentHints: Array.isArray(s.componentHints) ? [...s.componentHints] : [],
        included: s.included !== false
      }));
    }
    function parseBullets(text) {
      return text.split(/\r?\n/).map((x) => x.trim()).filter(Boolean).slice(0, 8);
    }
    async function parseApiResponse(res) {
      const text = await res.text();
      let data = {};
      try { data = text ? JSON.parse(text) : {}; } catch { throw new Error(`Non-JSON (${res.status}): ${text.slice(0, 120)}`); }
      if (!res.ok) throw new Error(data.error || `Request failed (${res.status})`);
      return data;
    }
    function registerObjectUrl(url) {
      if (url && String(url).startsWith("blob:")) activeObjectUrls.add(url);
    }
    function revokeObjectUrlsIn(container) {
      if (!container) return;
      Array.from(container.querySelectorAll("a[href^='blob:']")).forEach((a) => {
        const href = a.getAttribute("href");
        if (href) {
          try { URL.revokeObjectURL(href); } catch (_) {}
          activeObjectUrls.delete(href);
        }
      });
    }
    function revokeAllObjectUrls() {
      Array.from(activeObjectUrls).forEach((u) => {
        try { URL.revokeObjectURL(u); } catch (_) {}
      });
      activeObjectUrls.clear();
    }
    function renderHtmlActions(container, html, filename) {
      revokeObjectUrlsIn(container);
      container.innerHTML = "";
      const blob = new Blob([html], { type: "text/html;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      registerObjectUrl(url);

      const open = document.createElement("a");
      open.className = "btn";
      open.href = url;
      open.target = "_blank";
      open.rel = "noreferrer";
      open.textContent = "Open Slides";
      container.appendChild(open);

      const dl = document.createElement("a");
      dl.className = "btn";
      dl.href = url;
      dl.download = filename;
      dl.textContent = "Download HTML";
      container.appendChild(dl);
    }
    function renderVariantActions(container, variants, baseName) {
      revokeObjectUrlsIn(container);
      container.innerHTML = "";
      (Array.isArray(variants) ? variants : []).forEach((v, idx) => {
        const scoreText = (v?.score === null || v?.score === undefined)
          ? "N/A (fallback)"
          : Number(v.score).toFixed(1);
        const box = document.createElement("div");
        box.className = "row";
        box.style.border = "1px solid #dbe3ef";
        box.style.borderRadius = "8px";
        box.style.padding = "6px";
        const label = document.createElement("strong");
        label.textContent = `Variant ${idx + 1} (score ${scoreText})`;
        box.appendChild(label);
        const actions = document.createElement("div");
        actions.className = "row";
        renderHtmlActions(actions, String(v?.html || ""), `${baseName}-v${idx + 1}.html`);
        box.appendChild(actions);
        container.appendChild(box);
      });
    }

    function renderBoard() {
      boardEl.innerHTML = "";
      slides.forEach((slide, idx) => {
        const card = document.createElement("article");
        card.className = "card";
        card.draggable = true;
        card.addEventListener("dragstart", () => { dragIndex = idx; });
        card.addEventListener("dragover", (e) => e.preventDefault());
        card.addEventListener("drop", () => {
          if (dragIndex === null || dragIndex === idx) return;
          const moved = slides.splice(dragIndex, 1)[0];
          slides.splice(idx, 0, moved);
          dragIndex = null;
          renderBoard();
        });

        const top = document.createElement("div");
        top.className = "card-top";

        const check = document.createElement("input");
        check.type = "checkbox";
        check.checked = slide.included !== false;
        check.addEventListener("change", () => { slide.included = check.checked; });
        top.appendChild(check);

        const order = document.createElement("strong");
        order.textContent = `[${idx + 1}]`;
        top.appendChild(order);

        const title = document.createElement("input");
        title.className = "grow";
        title.value = slide.title;
        title.addEventListener("input", () => { slide.title = title.value; });
        top.appendChild(title);

        const type = document.createElement("select");
        ["cover", "summary", "content", "metric", "timeline", "two-column", "risk"].forEach((v) => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          if (slide.type === v) opt.selected = true;
          type.appendChild(opt);
        });
        type.addEventListener("change", () => { slide.type = type.value; });
        top.appendChild(type);

        const del = document.createElement("button");
        del.className = "danger";
        del.type = "button";
        del.textContent = "Delete";
        del.addEventListener("click", () => { slides.splice(idx, 1); renderBoard(); });
        top.appendChild(del);

        card.appendChild(top);

        const bullets = document.createElement("textarea");
        bullets.value = slide.bullets.join("\n");
        bullets.addEventListener("input", () => { slide.bullets = parseBullets(bullets.value); });
        card.appendChild(bullets);

        boardEl.appendChild(card);
      });
    }

    analyzeForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const files = document.getElementById("documents").files;
      const workflow = "direct-html";
      if (!files.length) return setStatus("Select files first.");
      setBusy(true);
      hideQualityGate();
      clearProgressLog();
      startProgress("Generating HTML from documents");
      addProgressLog("Preparing upload payload");
      setStatus("Generating HTML with Gemini...");
      revokeAllObjectUrls();
      resultActionsEl.innerHTML = "";
      directResultActionsEl.innerHTML = "";
      directResultSection.classList.add("hidden");
      approvalSection.classList.add("hidden");
      metaEl.textContent = "";

      const body = new FormData();
      for (const file of files) body.append("documents", file);
      body.append("model", llmModelInput.value || "gemini-3-flash-preview");
      body.append("workflow", "direct-html");
      body.append("variantCount", "1");
      body.append("referenceMode", "off");
      body.append("pageMode", "default");
      try {
        addProgressLog(`Uploading ${files.length} file(s)`);
        addProgressLog("Calling /api/generate-llm");
        trackModelCall(llmModelInput.value || "gemini-3-flash-preview");
        const data = await parseApiResponse(await fetch("/api/generate-llm", { method: "POST", body }));
        addProgressLog("Received response");
        currentMode = data.mode || "llm-gemini";

        const variants = Array.isArray(data.htmlVariants) && data.htmlVariants.length
          ? data.htmlVariants
          : [{ html: data.html, score: 0 }];
        const topVariant = variants[0] || {};
        const why = topVariant.whyFallback || "-";
        const whyText = (topVariant.renderMode === "fallback" && why !== "-") ? `WHY:${why}` : `Why:${why}`;
        metaEl.textContent = `Mode: ${currentMode} | RenderMode: ${topVariant.renderMode || "-"} | ${whyText} | extraction:${topVariant.extractionMethod || "-"} | finalized:${String(!!topVariant.finalizeApplied)} | repair:${String(!!topVariant.repairAttempted)} | Files: ${(data.sourceFiles || []).join(", ")} | Ref: ${data.referenceModeUsed || "off"} | Workflow: direct-html | Variants: ${variants.length} (requested: ${data.variantRequested || 1}, produced: ${data.variantProduced || variants.length})`;
        renderVariantActions(directResultActionsEl, variants, `direct-house-nextgen-exec`);
        directResultSection.classList.remove("hidden");
        setStatus(`Direct HTML generated (${currentMode}, house-nextgen-exec, ref:${data.referenceModeUsed || "off"}).`);
      } catch (err) {
        addProgressLog("Direct generate failed");
        setStatus(`Error: ${err.message}`);
      } finally {
        stopProgress();
        setBusy(false);
        if (qualityDecisionPending) approveBtn.disabled = true;
      }
    });
    retryAnalyzeBtn.addEventListener("click", () => {
      hideQualityGate();
      analyzeForm.requestSubmit();
    });
    continueAnalyzeBtn.addEventListener("click", () => {
      hideQualityGate();
      setStatus("?덉쭏 寃쎄퀬瑜??뺤씤?덇퀬, ?꾩옱 珥덉븞?쇰줈 怨꾩냽 吏꾪뻾?⑸땲??");
    });

    addSlideBtn.addEventListener("click", () => {
      slides.push({ id: `custom_${Date.now()}`, title: `New Slide ${slides.length + 1}`, bullets: ["Add content"], type: "content", included: true });
      renderBoard();
    });
    resetBtn.addEventListener("click", () => {
      slides = cloneSlides(originalSlides);
      renderBoard();
      setStatus("Reset complete.");
    });

    approveBtn.addEventListener("click", async () => {
      if (!slides.length) return setStatus("No slides to render.");
      setBusy(true);
      startRenderBusy();
      setStatus("Rendering with Gemini...");
      revokeObjectUrlsIn(resultActionsEl);
      resultActionsEl.innerHTML = "";
      try {
        trackModelCall(renderModelInput.value || "gemini-3-flash-preview");
        const data = await parseApiResponse(await fetch("/api/render-llm", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            slides,
            model: renderModelInput.value || "gemini-3-flash-preview",
            referenceMode: "off",
            pageMode: "default"
          })
        }));
        renderHtmlActions(
          resultActionsEl,
          data.html || "",
          `approved-house-nextgen-exec.html`
        );

        setStatus(`Rendered ${data.slideCount} slides via ${data.mode || currentMode} (house-nextgen-exec, ref:${data.referenceModeUsed || "off"}, default)`);
      } catch (err) {
        setStatus(`Error: ${err.message}`);
      } finally {
        stopRenderBusy();
        setBusy(false);
      }
    });
    loadModelCallStatsState();
    renderModelCallStats();
    if (modelCallResetWatcher) clearInterval(modelCallResetWatcher);
    modelCallResetWatcher = setInterval(() => {
      renderModelCallStats();
    }, 30000);
    window.addEventListener("beforeunload", () => {
      revokeAllObjectUrls();
    });
  </script>
</body>
</html>




